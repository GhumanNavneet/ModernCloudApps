{
  "if": {
    "anyOf": [
      {
        "allOf": [
          {
            "source": "action",
            "equals": "Microsoft.Storage/storageAccounts/write"
          },
          {
            "field": "type",
            "equals": "Microsoft.Storage/storageAccounts"
          },
          {
            "not": {
              "field": "Microsoft.Storage/storageAccounts/sku.name",
              "in": [
                "Standard_RA-GRS",
                "Standard_LRS"
              ]
            }
          },
          {
            "not": {
              "field": "Microsoft.Storage/storageAccounts/accessTier",
              "equals": "cool"
            }
          }
        ]
      },
      {
        "name": "audit-sql-db-tde-status",
        "properties": {
            "displayName": "Audit transparent data encryption status",
            "description": "Audit transparent data encryption status for SQL databases",
            "parameters": {},
            "policyRule": {
                "if": {
                    "field": "type",
                    "equals": "Microsoft.SQL/servers/databases"
                },
                "then": {
                    "effect": "auditIfNotExists",
                    "details": {
                        "type": "Microsoft.SQL/servers/databases/transparentDataEncryption",
                        "name": "current",
                        "existenceCondition": {
                            "field": "Microsoft.Sql/transparentDataEncryption.status",
                            "equals": "enabled"
                        }
                    }
                }
            }
        }
    },
    {
      "properties": {
          "displayName": "Audit SQL DB Level Audit Setting",
          "description": "Audit DB level audit setting for SQL databases",
          "parameters": {
              "setting": {
                  "type": "String",
                   "allowedValues": [
                          "enabled",
                          "disabled"
                  ],
                  "metadata": {
                      "displayName": "Audit Setting"
                  }
              }
          },
          "policyRule": {
              "if": {
                  "field": "type",
                  "equals": "Microsoft.SQL/servers/databases"
              },
              "then": {
                  "effect": "auditIfNotExists",
                  "details": {
                      "type": "Microsoft.SQL/servers/databases/auditingSettings",
                      "name": "current",
                      "existenceCondition": {
                          "field": "Microsoft.Sql/auditingSettings.state",
                          "equals": "[parameters('setting')]"
                      }
                  }
              }
          }
      }
  },
  {
    "name": "audit-sql-db-threat-detection",
    "properties": {
        "displayName": "Audit DB level threat detection setting",
        "description": "Audit threat detection setting for SQL databases",
        "parameters": {
            "setting": {
                "type": "String",
                "allowedValues": [
                    "enabled",
                    "disabled"
                ],
                "metadata": {
                    "displayName": "Threat Detection Setting"
                }
            }
        },
        "policyRule": {
            "if": {
                "field": "type",
                "equals": "Microsoft.SQL/servers/databases"
            },
            "then": {
                "effect": "auditIfNotExists",
                "details": {
                    "type": "Microsoft.SQL/servers/databases/securityAlertPolicies",
                    "name": "default",
                    "existenceCondition": {
                        "field": "Microsoft.Sql/securityAlertPolicies.state",
                        "equals": "[parameters('setting')]"
                    }
                }
            }
        }
    }
},
{
  "properties": {
      "displayName": "Audit SQL Server Level Audit Setting",
      "description": "Audit Audit Setting for SQL Server",
      "parameters": {
          "setting": {
              "type": "String",
              "allowedValues": [
                  "enabled",
                  "disabled"
              ],
              "metadata": {
                  "displayName": "Audit Setting"
              }
          }
      },
      "policyRule": {
          "if": {
              "field": "type",
              "equals": "Microsoft.SQL/servers"
          },
          "then": {
              "effect": "auditIfNotExists",
              "details": {
                  "type": "Microsoft.SQL/servers/auditingSettings",
                  "name": "current",
                  "existenceCondition": {
                      "allOf": [
                          {
                              "field": "Microsoft.Sql/auditingSettings.state",
                              "equals": "[parameters('setting')]"
                          }
                      ]
                  }
              }
          }
      }
  }
},
{
  "properties": {
      "displayName": "Audit Server level threat detection setting",
      "description": "Audit threat detection setting for SQL Server",
      "parameters": {
          "setting": {
              "type": "String",
              "allowedValues": [
                  "enabled",
                  "disabled"
              ],
              "metadata": {
                  "displayName": "Threat Detection Setting"
              }
          }
      },
      "policyRule": {
          "if": {
              "field": "type",
              "equals": "Microsoft.SQL/servers"
          },
          "then": {
              "effect": "auditIfNotExists",
              "details": {
                  "type": "Microsoft.SQL/servers/securityAlertPolicies",
                  "name": "default",
                  "existenceCondition": {
                      "allOf": [
                          {
                              "field": "Microsoft.Sql/securityAlertPolicies.state",
                              "equals": "[parameters('setting')]"
                          }
                      ]
                  }
              }
          }
      }
  }
},
{
  "properties": {
      "displayName": "Allowed SQL DB SKUs",
      "description": "This policy enables you to specify a set of SQL DB SKUs",
      "parameters": {
          "listOfSKUId": {
              "type": "Array",
              "metadata": {
                  "description": "The list of SKUs that can be specified for SQL Databases.",
                  "displayName": "Allowed SKU IDs",
                  "strongType": "requestedServiceObjectiveId"
              }
          },
          "listOfSKUName": {
              "type": "Array",
              "metadata": {
                  "description": "The list of SKUs that can be specified for SQL Databases.",
                  "displayName": "Allowed SKU Names",
                  "strongType": "requestedServiceObjectiveName"
              }
          }
      },
      "policyRule": {
          "if": {
              "allOf": [
                  {
                      "field": "type",
                      "equals": "Microsoft.SQL/servers/databases"
                  },
                  {
                      "not": {
                          "anyOf": [
                              {
                                  "field": "Microsoft.SQL/servers/databases/requestedServiceObjectiveId",
                                  "in": "[parameters('listOfSKUId')]"
                              },
                              {
                                  "field": "Microsoft.SQL/servers/databases/requestedServiceObjectiveName",
                                  "in": "[parameters('listOfSKUName')]"
                              }
                          ]
                      }
                  }
              ]
          }
        }
      }
        },
{
  "properties": {
      "displayName": "Audit If no AAD Admin",
      "description": "Aduit If there is no AAD Admin assigned to this server",
      "parameters": {
         
      },
      "policyRule": {
          "if": {
              "field": "type",
              "equals": "Microsoft.SQL/servers"
          },
          "then": {
              "effect": "auditIfNotExists",
              "details": {
                  "type": "Microsoft.SQL/servers/administrators"
              }
          }
      }
  }
},

      {
        "allOf": [
          {
            "source": "action",
            "equals": "Microsoft.Compute/virtualMachines/write"
          },
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "not": {
              "field": "Microsoft.Compute/virtualMachines/sku.name",
              "in": [ "Standard_DS2_v2","Standard_D2_v2","Standard_D2"]
            }
          }
        ]
      },
      {
        "not": {
          "anyOf": [
            {
              "field": "type",
              "like": "Microsoft.Resources/*"
            },
            {
              "field": "type",
              "like": "Microsoft.Compute/*"
            },
            {
              "field": "type",
              "like": "Microsoft.Storage/*"
            },
            {
              "field": "type",
              "like": "Microsoft.Network/*"
            },
            {
              "field": "type",
              "like": "Microsoft.Web/sites/*"
            },
            {
              "field": "type",
              "like": "Microsoft.Web/serverfarms/*"
            },
              {
                "field": "type",
                "like": "Microsoft.Sql/servers/*"
              },  
            {
              "field": "type",
              "like": "Microsoft.Sql/servers/databases/*"
            },
            {
              "field": "type",
              "like": "Microsoft.AzureActiveDirectory/b2cDirectories/*"
            },
            {
              "field": "type",
              "like": "Microsoft.Logic/workflows/*"
            }
          ]
        }
      },
      {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "not": {
              "allOf": [
                {
                  "field": "Microsoft.Compute/virtualMachines/imagePublisher",
                  "equals": "MicrosoftVisualStudio"
                },
                {
                  "field": "Microsoft.Compute/virtualMachines/imageOffer",
                  "equals": "VisualStudio"
                },
                {
                  "field": "Microsoft.Compute/virtualMachines/imageSku",
                  "in": ["VS-2017-Comm-Latest-WS2016"]
                }
              ]
            }
          }
        ]
      }
    ]
  },
  "then": {
    "effect": "deny"
  }
}
